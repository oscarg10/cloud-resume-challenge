---
- name: Build & deploy SAM (Python counter)
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    stack_name: counter-api
    template_file: "{{ (playbook_dir | realpath, '..', 'backend-counter.yaml') | path_join }}"
    parameter_overrides:
      TableName: CounterTable
      CounterPrimaryKeyValue: global
    sam_build_use_container: false
  vars_files:
    - vaults/prod.yml
  tasks:
    - name: Ensure SAM CLI is available
      ansible.builtin.command: sam --version
      changed_when: false
      failed_when: false
      register: sam_check

    - name: Fail if SAM CLI is not installed
      ansible.builtin.fail:
        msg: "SAM CLI is not installed. Install it with: pip install aws-sam-cli"
      when: sam_check.rc != 0

    - name: Validate SAM template
      ansible.builtin.command:
        cmd: >-
          sam validate
          --template-file "{{ template_file }}"
          --region {{ AWS_REGION }}
      environment:
        AWS_REGION: "{{ AWS_REGION }}"
        AWS_ACCESS_KEY_ID: "{{ AWS_ACCESS_KEY_ID }}"
        AWS_SECRET_ACCESS_KEY: "{{ AWS_SECRET_ACCESS_KEY }}"
      args:
        chdir: "{{ playbook_dir | realpath }}/.."

    - name: SAM build
      ansible.builtin.command:
        cmd: >-
          sam build
          --template-file "{{ template_file }}"
          {{ sam_build_use_container | ternary('--use-container', '') }}
      environment:
        AWS_REGION: "{{ AWS_REGION }}"
        AWS_ACCESS_KEY_ID: "{{ AWS_ACCESS_KEY_ID }}"
        AWS_SECRET_ACCESS_KEY: "{{ AWS_SECRET_ACCESS_KEY }}"
      args:
        chdir: "{{ playbook_dir | realpath }}/.."

    - name: Build parameter overrides string
      ansible.builtin.set_fact:
        param_string: >-
          {%- for key, value in parameter_overrides.items() -%}
          ParameterKey={{ key }} ParameterValue={{ value }}
          {%- if not loop.last %} {% endif -%}
          {%- endfor -%}

    - name: SAM deploy (create/update stack)
      ansible.builtin.command:
        cmd: >-
          sam deploy
          --stack-name {{ stack_name }}
          --region {{ AWS_REGION }}
          --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND
          --resolve-s3
          --no-confirm-changeset
          --no-fail-on-empty-changeset
          --parameter-overrides {{ param_string }}
      environment:
        AWS_REGION: "{{ AWS_REGION }}"
        AWS_ACCESS_KEY_ID: "{{ AWS_ACCESS_KEY_ID }}"
        AWS_SECRET_ACCESS_KEY: "{{ AWS_SECRET_ACCESS_KEY }}"
      args:
        chdir: "{{ playbook_dir | realpath }}/.."
      register: deploy_result

    - name: Display deployment result
      ansible.builtin.debug:
        var: deploy_result.stdout_lines
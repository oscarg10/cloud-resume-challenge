---
- name: Invalidate CloudFront Cache
  hosts: localhost
  gather_facts: false
  vars_files:
    - vaults/prod.yml
  tasks:
    - name: Get CloudFront Distribution ID using AWS CLI
      ansible.builtin.shell: |
        aws cloudformation describe-stack-resources \
          --stack-name {{ STACK_NAME }} \
          --region {{ AWS_REGION }} \
          --logical-resource-id CloudFrontDistribution \
          --query 'StackResources[0].PhysicalResourceId' \
          --output text
      environment:
        AWS_ACCESS_KEY_ID: "{{ AWS_ACCESS_KEY_ID }}"
        AWS_SECRET_ACCESS_KEY: "{{ AWS_SECRET_ACCESS_KEY }}"
        AWS_DEFAULT_REGION: "{{ AWS_REGION }}"
      register: distribution_id_result
      changed_when: false

    - name: Set distribution ID fact
      set_fact:
        cloudfront_distribution_id: "{{ distribution_id_result.stdout }}"

    - name: Fail if distribution ID not found
      ansible.builtin.fail:
        msg: "Could not find CloudFrontDistribution in stack {{ STACK_NAME }}"
      when: cloudfront_distribution_id == "" or "None" in cloudfront_distribution_id

    - name: Create CloudFront invalidation
      community.aws.cloudfront_invalidation:
        region: "{{ AWS_REGION }}"
        aws_access_key: "{{ AWS_ACCESS_KEY_ID }}"
        aws_secret_key: "{{ AWS_SECRET_ACCESS_KEY }}"
        distribution_id: "{{ cloudfront_distribution_id }}"
        target_paths:
          - "/*"
        caller_reference: "{{ lookup('pipe', 'date +%s') }}"
      register: invalidation_result

    - name: Display invalidation ID
      ansible.builtin.debug:
        msg: "Invalidation created with ID: {{ invalidation_result.invalidation.id }}"